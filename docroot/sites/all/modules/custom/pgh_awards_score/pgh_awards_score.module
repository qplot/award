<?php

/**
 * @file
 * Score module.
 *
 * @author Fang Jin <fang@designhammer.com>
 */

/**
 * Implements hook_menu().
 */
function pgh_awards_score_menu() {
  $items = array();

  // Calculate category score for one application.
  $items['admin/score/application/%/calculate'] = array(
    'title' => 'Calculate category score',
    'description' => 'Calculate all score for application category',
    'page callback' => 'pgh_awards_score_calculate_application_page',
    'page arguments' => array(3),
    'access arguments' => array('administer awards system'),
  );

  // Calculate all scores for one application type.
  $items['admin/score/apptype/%/calculate'] = array(
    'title' => 'Calculate scores for application type',
    'description' => 'Calculate scores for application type',
    'page callback' => 'drupal_get_form',
    'page arguments' => array("pgh_awards_score_calculate_apptype_form", 3),
    'access arguments' => array('administer awards system'),
  );

  // Migrate all scores for one application type.
  $items['admin/content/migrate/score'] = array(
    'title' => 'Score',
    'description' => 'Migrate scores for application type',
    'page callback' => 'drupal_get_form',
    'page arguments' => array("pgh_awards_score_migrate_form", 3),
    'access arguments' => array('administer awards system'),
  );

  // Migrate all scores for one application type.
  $items['admin/content/migrate/checkboxes'] = array(
    'title' => 'Checkboxes',
    'description' => 'Fix migrate checkbox values for application type',
    'page callback' => 'drupal_get_form',
    'page arguments' => array("pgh_awards_score_checkboxes_form", 3),
    'access arguments' => array('administer awards system'),
  );

  return $items;
}

/**
 * Calculate score for each category of application.
 *
 * Currently this function is retired. Waiting for merged into drush script
 *
 * @author Fang Jin <fang@designhammer.com>
 */
function pgh_awards_score_calculate_application_metric_page($app_id, $apptype = 'partner_for_change', $goto = TRUE) {
  // Find application type.
  $atid = pgh_api_find_nodes(
    array(
      'type' => 'apptype',
      'title' => $apptype,
    )
  );
  $app_type = node_load($atid);
  $awrapper = entity_metadata_wrapper('node', $app_type);
  $cids = $awrapper->field_apptype_categories->raw();

  foreach ($cids as $cid) {
    // Find all metrics for each.
    $mids = pgh_api_find_nodes(
      array(
        'type' => 'metric',
        'field_metric_category' => array('target_id', $cid, '=')
      ),
      array('created' => 'ASC'),
      TRUE
    );

    foreach ($mids as $mid) {
      // Calculate value.
      $metric_value = pgh_awards_score_calculate_metric($app_id, $mid);

      // Find metric response object.
      if ($mrid = pgh_api_find_nodes(
        array(
          'type' => 'metric_response',
          'field_metric_response_app' => array('target_id', $app_id , '='),
          'field_metric_response_metric' => array('target_id', $mid , '='),
        )
      )) {
        $response = node_load($mrid);
        $wrapper = entity_metadata_wrapper('node', $response);
      }
      else {
        // Create a new metric response.
        $response = entity_create('node', array('type' => 'metric_response'));
        $wrapper = entity_metadata_wrapper('node', $response);
        $wrapper->field_metric_response_app->set($app_id);
        $wrapper->field_metric_response_metric->set($mid);
      }

      // Store response object.
      $wrapper->title = 'app_' . $app_id . '_m_' . $mid;
      $wrapper->field_metric_response_value->set($metric_value['value']);
      $wrapper->field_metric_response_score->set($metric_value['score']);

      $wrapper->save();
    }
  }
  if ($goto) {
    drupal_goto();
  }
}

/**
 * Hook views_pre_render.
 */
function pgh_awards_score_views_pre_render(&$view) {
  // Add calculate button for now.
  if ($view->name == 'metric_score') {
    $app_id = arg(3);
    $items = array();
    $items[] = l(
      t('Calculate'),
      "admin/score/application/$app_id/calculate",
      array('query' => drupal_get_destination())
    );
    $view->attachment_before = theme('item_list', array(
      'items' => $items,
      'attributes' => array('class' => 'action-links')
    ));
  }
  if ($view->name == 'score_application') {
    $app_id = arg(3);
    $items = array();
    $items[] = l(
      t('Calculate'),
      "admin/score/application/$app_id/calculate",
      array('query' => drupal_get_destination())
    );
    $view->attachment_before = theme('item_list', array(
      'items' => $items,
      'attributes' => array('class' => 'action-links')
    ));
  }
}

/**
 * Calculate the metric score for metric object.
 *
 * @param int $app_id
 *   Application node id
 *
 * @param int $metric_id
 *   Metric node id
 *
 * @return mixed 
 *   Array of scores
 *
 * @author Fang Jin <fang@designhammer.com>
 */
function pgh_awards_score_calculate_metric($app_id, $metric_id) {
  $node = node_load($metric_id);
  $wrapper = entity_metadata_wrapper('node', $node);
  $formula = $wrapper->field_metric_formula->value();
  $reference = $wrapper->field_metric_reference->value();
  $orientation = $wrapper->field_metric_orientation->value();

  $score = pgh_awards_score_calculate_formula($app_id, $formula, $reference, $orientation);
  $score['metric_id'] = $metric_id;

  return $score;
}

/**
 * Calculate the metric score.
 *
 * @param int $app_id
 *   Application ID
 *
 * @param string $formula
 *   Formula string containing question tag and equations
 *
 * @param int $reference
 *   Reference value, most of time 100
 *
 * @param string $orientation
 *   Key of orientation, 'low' or 'high'
 *
 * @return array
 *   Array of value, array('value'=> $value, 'score' => $score)
 *
 * @author Fang Jin <fang@designhammer.com>
 */
function pgh_awards_score_calculate_formula($app_id, $formula, $reference = 100, $orientation = 'high') {
  $value = 0;
  $score = 0;
  // Pattern match the formula to find all variables with pghq_ prefix.
  $matches = array();
  if (preg_match_all('/\bpghq_[\w]*/', $formula, $matches)) {
    if (!empty($matches[0])) {
      $variables = array();
      foreach ($matches[0] as $match) {
        $qid = pgh_api_find_nodes(
          array(
            'type' => 'question',
            'title' => $match,
          )
        );
        if ($qid && !isset($variables[$match])) {
          if ($response = pgh_api_get_response($app_id, $qid)) {
            $value = !empty($response['value']) ? $response['value'] : '0';
            // Convert anything into a string, https://bugs.php.net/bug.php?id=39579.
            $value = "'" . $value . "'";
            $variables[$match] = array(
              'question' => $match,
              'value' => $value,
            );
          }
        }
      }
      // Sort variables by variable length.
      uksort($variables, create_function('$a,$b', 'return strlen($a) < strlen($b);'));

      // Evaluate the formula.
      $replace = $formula;
      foreach ($variables as $variable) {
        $replace = str_replace($variable['question'], $variable['value'], $replace);
      }
      // Suppress error for now.
      try {
        $value = eval("return @($replace);");
      }
      catch (Exception $e) {
        // Can't catch this error for now, needs better solution, ex. writing script to file.
        watchdog('pgh_score', 'Error in eval on %var', array('%var' => $replace), WATCHDOG_ERROR);
        return array('value' => $value, 'score' => $score);
      }
      // Special cutoff here, bypass normalization. https://ac.designhammer.net/projects/practice-greenhealth-phase-12/tasks/59
      if ($value <= 0.0) {
        $value = 0.0;
        $score = 0.0;
      }
      else {
        // Calculate score.
        $score = $value / $reference * 100.0;
        if ($orientation == 'low') {
          $score = 100.0 - $score;
        }
        // Bound score.
        if ($score < 0) {
          $score = 0.0;
        }
        if ($score > 100) {
          $score = 100.0;
        }
      }
    }
  }
  return array('value' => $value, 'score' => $score);
}

/**
 * Calculate metric score for specific category of specific application.
 *
 * @param int $app_id
 *   Application node id
 *
 * @param int $cat_id
 *   Category node id
 *
 * @param bool $save
 *   If score should be saved
 * 
 * @return mixed 
 *   Array of scores
 *
 * @author Fang Jin <fang@designhammer.com>
 */
function pgh_awards_score_calculate_application_category_metric($app_id, $cat_id, $save = TRUE) {
  // Find all metrics for each category.
  $mids = pgh_api_find_nodes(
    array(
      'type' => 'metric',
      // Missing application type.
      'field_metric_category' => array('target_id', $cat_id, '=')
    ),
    array('created' => 'ASC'),
    TRUE
  );
  $metric_values = array(
    'metric_p' => 0,
    'metric' => 0,
    'metric_count' => 0,
  );
  // For each metric.
  foreach ($mids as $mid) {
    // Calculate value.
    $metric_value = pgh_awards_score_calculate_metric($app_id, $mid);
    // Save to metric response.
    if ($save) {
      // Find metric response object.
      if ($mrid = pgh_api_find_nodes(
        array(
          'type' => 'metric_response',
          'field_metric_response_app' => array('target_id', $app_id , '='),
          'field_metric_response_metric' => array('target_id', $mid , '='),
        )
      )) {
        $response = node_load($mrid);
        $wrapper = entity_metadata_wrapper('node', $response);
      }
      else {
        // Create a new metric response.
        $response = entity_create('node', array('type' => 'metric_response'));
        $wrapper = entity_metadata_wrapper('node', $response);
        $wrapper->field_metric_response_app->set($app_id);
        $wrapper->field_metric_response_metric->set($mid);
      }

      // Store response object.
      $wrapper->title = 'app_' . $app_id . '_m_' . $mid;
      $wrapper->field_metric_response_value->set($metric_value['value']);
      $wrapper->field_metric_response_score->set($metric_value['score']);

      $wrapper->save();
    }

    // $metric_values['point'] += $metric_value['point'];
    $metric_values['metric'] += $metric_value['score'];
    $metric_values['metric_count'] += 1;
  }
  return $metric_values;
}

/**
 * Calculate score for category and store in category response.
 *
 * @param int $app_id
 *   Application node id
 *
 * @param int $cat_id
 *   Category node id
 *
 * @param bool $save
 *   If score should be saved
 * 
 * @return mixed 
 *   Array of scores
 *
 * @author Fang Jin <fang@designhammer.com>
 */
function pgh_awards_score_calculate_application_category($app_id, $cat_id, $save = TRUE) {
  $scores = array(
    'automatic_p' => 0,
    'automatic' => 0,
    'kpi_p' => 0,
    'kpi' => 0,
    'metric_p' => 0,
    'metric' => 0,
    'quality_p' => 0,
    'quality' => 0,
    'question_count' => 0,
    'metric_count' => 0,
  );

  // Aggregate automatic and kpi scores.
  $category = node_load($cat_id);
  $category_wrapper = entity_metadata_wrapper('node', $category);
  foreach ($category_wrapper->field_category_sections->getIterator() as $section_wrapper) {
    $qids = $section_wrapper->field_section_questions->raw();

    // Find all response id associated with these questions.
    if ($qids && ($rids = pgh_api_find_nodes(
      array(
        'type' => 'response',
        'field_response_application' => array('target_id', $app_id, '='),
        'field_response_question' => array('target_id', $qids, 'IN'),
      ),
      NULL, TRUE
    ))) {
      // Aggregate the scores.
      $responses = node_load_multiple($rids);
      foreach ($responses as &$response) {
        $response_wrapper = entity_metadata_wrapper('node', $response);
        // Calculate automatic scores.
        $scores['automatic_p'] += intval($response_wrapper->field_response_point->value());
        $scores['automatic'] += intval($response_wrapper->field_response_score->value());
        // Calculate kpi scores.
        $kpi = $response_wrapper->field_response_kpi->value();
        if ($kpi !== '') {
          $scores['kpi_p'] += 1;
          $scores['kpi'] += intval($kpi);
        }
        // Calculate other stat.
        $scores['question_count'] += 1;
        // dsm($response_wrapper->field_response_question->raw());
        // dsm($response->nid);
        // dsm('AP:' . $scores['automatic_p']);
      }
    }
  }

  // Aggregate metric scores.
  $metric_scores = pgh_awards_score_calculate_application_category_metric($app_id, $cat_id, $save);
  $scores = array_merge($scores, $metric_scores);
  $scores['metric_p'] = $scores['metric_count'] * 100;

  return $scores;
}

/**
 * Calculate score for application.
 *
 * @param int $app_id
 *   Application node id
 *
 * @param bool $save
 *   If score should be saved
 * 
 * @return mixed 
 *   Array of scores
 *
 * @author Fang Jin <fang@designhammer.com>
 */
function pgh_awards_score_calculate_application($app_id, $save = TRUE) {
  // Find all categories.
  $sums = array(
    'automatic_p' => 0,
    'automatic' => 0,
    'kpi_p' => 0,
    'kpi' => 0,
    'metric_p' => 0,
    'metric' => 0,
    'quality' => 0,
    'quality_p' => 0,
    'question_count' => 0,
    'metric_count' => 0,
    'final' => 0,
    'final_p' => 0,
  );
  if ($app = node_load($app_id)) {
    // Find app type.
    $apptype_tag = $app->field_application_type['und'][0]['value'];
    $apptype_id = pgh_api_find_nodes(array('type' => 'apptype', 'title' => $apptype_tag));
    $apptype = node_load($apptype_id);
    $apptype_wrapper = entity_metadata_wrapper('node', $apptype);
    $quality_disable_cids = pgh_awards_score_quality_disabled_categories($apptype_tag);

    $cids = $apptype_wrapper->field_apptype_categories->raw();
    foreach ($cids as $cat_id) {
      $scores = pgh_awards_score_calculate_application_category($app_id, $cat_id, $save);

      // Save to category response.
      if ($save) {
        if ($rid = pgh_api_find_nodes(
          array(
            'type' => 'category_response',
            'field_cat_response_application' => array('target_id', $app_id, '='),
            'field_cat_response_category' => array('target_id', $cat_id, '='),
          )
        )) {
          $cat_response = node_load($rid);
          $cat_response_wrapper = entity_metadata_wrapper('node', $cat_response);
        }
        else {
          $cat_response = entity_create('node', array('type' => 'category_response'));
          $cat_response_wrapper = entity_metadata_wrapper('node', $cat_response);
          $cat_response_wrapper->field_cat_response_application->set($app_id);
          $cat_response_wrapper->field_cat_response_category->set($cat_id);
          $cat_response_wrapper->title->set('app_' . $app_id . '_cat_' . $cat_id);
        }
        $cat_response_wrapper->field_cat_response_automatic_p->set($scores['automatic_p']);
        $cat_response_wrapper->field_cat_response_automatic->set($scores['automatic']);
        $cat_response_wrapper->field_cat_response_kpi_p->set($scores['kpi_p']);
        $cat_response_wrapper->field_cat_response_kpi->set($scores['kpi']);
        $cat_response_wrapper->field_cat_response_metric_p->set($scores['metric_p']);
        $cat_response_wrapper->field_cat_response_metric->set($scores['metric']);

        // Based on the application type, hidden tag is stored as 0 here.
        $quality_p = in_array($cat_id, $quality_disable_cids) ? 0 : 100;
        $cat_response_wrapper->field_cat_response_quality_p->set($quality_p);

        // Calculate and store final score.
        $weight = $apptype_wrapper->field_apptype_score_weights->value();
        $wp = explode('|', $weight);
        if (count($wp) < 4) {
          $wp = array(0.45, 0.25, 0.15, 0.15);
        }
        $scores['final'] = $wp[0] * $scores['automatic'] + $wp[1] * $scores['kpi'] + $wp[2] * $scores['metric'] + $wp[3] * $scores['quality'];
        $scores['final_p'] = $wp[0] * $scores['automatic_p'] + $wp[1] * $scores['kpi_p'] + $wp[2] * $scores['metric_p'] + $wp[3] * $scores['quality_p'];
        $cat_response_wrapper->field_cat_response_final->set($scores['final']);
        $cat_response_wrapper->field_cat_response_final_p->set($scores['final_p']);

        $cat_response_wrapper->save();
      }

      foreach ($scores as $key => $score) {
        $sums[$key] += $score;
      }
    }

    // Save to application.
    if ($save) {
      $app_wrapper = entity_metadata_wrapper('node', $app);

      $app_wrapper->field_application_automatic_p->set($sums['automatic_p']);
      $app_wrapper->field_application_automatic->set($sums['automatic']);
      $app_wrapper->field_application_kpi_p->set($sums['kpi_p']);
      $app_wrapper->field_application_kpi->set($sums['kpi']);
      $app_wrapper->field_application_metric_p->set($sums['metric_p']);
      $app_wrapper->field_application_metric->set($sums['metric']);
      $app_wrapper->field_application_quality_p->set($sums['quality_p']);
      $app_wrapper->field_application_quality->set($sums['quality']);
      $app_wrapper->field_application_final->set($sums['final']);

      $app_wrapper->save();
    }
  }

  return $sums;
}

/**
 * Page for calculation of scores for application.
 *
 * This page will redirect to previous submitted page,
 * it's usually associated with a button or link.
 */
function pgh_awards_score_calculate_application_page($app_id) {
  pgh_awards_score_calculate_application($app_id, TRUE);
  drupal_set_message('Score has been calculated for application: ' . $app_id);
  drupal_goto();
}

/**
 * Get all score for application.
 *
 * @param int $app_id
 *   The NID of application
 *
 * @return mixed
 *   The array info with all category scores.
 *
 * @author Fang Jin <fang@designhammer.com>
 */
function pgh_awards_score_application($app_id, $include_metric = FALSE) {
  $app = node_load($app_id);
  $app_wrapper = entity_metadata_wrapper('node', $app);

  // Find app type.
  $apptype_tag = $app_wrapper->field_application_type->raw();
  $apptype_id = pgh_api_find_nodes(array('type' => 'apptype', 'title' => $apptype_tag));
  $apptype = node_load($apptype_id);
  $apptype_wrapper = entity_metadata_wrapper('node', $apptype);

  // Get available categories.
  $cat_ids = $apptype_wrapper->field_apptype_categories->raw();

  // Get all category responses.
  $responses = array();
  $cat_response_ids = pgh_api_find_nodes(
    array(
      'type' => 'category_response',
      'field_cat_response_application' => array('target_id', $app->nid, '='),
    ),
    NULL,
    TRUE
  );
  foreach ($cat_response_ids as $crid) {
    $cat_response = node_load($crid);
    $cat_response_wrapper = entity_metadata_wrapper('node', $cat_response);
    $cid = $cat_response_wrapper->field_cat_response_category->raw();
    $body = $cat_response_wrapper->body->value();

    $responses['cat_' . $cid] = array(
      'category_id' => intval($cid),
      'response_id' => intval($crid),
      'final' => $cat_response_wrapper->field_cat_response_final->value(),
      'final_p' => $cat_response_wrapper->field_cat_response_final_p->value(),
      'automatic_p' => $cat_response_wrapper->field_cat_response_automatic_p->value(),
      'automatic' => $cat_response_wrapper->field_cat_response_automatic->value(),
      'kpi_p' => $cat_response_wrapper->field_cat_response_kpi_p->value(),
      'kpi' => $cat_response_wrapper->field_cat_response_kpi->value(),
      'metric_p' => $cat_response_wrapper->field_cat_response_metric_p->value(),
      'metric' => $cat_response_wrapper->field_cat_response_metric->value(),
      'quality_p' => $cat_response_wrapper->field_cat_response_quality_p->value(),
      'quality' => $cat_response_wrapper->field_cat_response_quality->value(),
      'comment' => !empty($body['value']) ? $body['value'] : '',
      'case_study' => $cat_response_wrapper->field_cat_response_case_study->value(),
    );
  }

  // Get all metric responses.
  if ($include_metric) {
    $metrics = array();
    $metric_response_ids = pgh_api_find_nodes(
      array(
        'type' => 'metric_response',
        'field_metric_response_app' => array('target_id', $app->nid, '='),
      ),
      NULL,
      TRUE
    );

    foreach ($metric_response_ids as $mrid) {
      $metric_response = node_load($mrid);
      $metric_response_wrapper = entity_metadata_wrapper('node', $metric_response);
      $metric_id = $metric_response_wrapper->field_metric_response_metric->raw();
      $metric = node_load($metric_id);
      $metric_wrapper = entity_metadata_wrapper('node', $metric);
      $cid = $metric_wrapper->field_metric_category->raw();
      $body = $metric_wrapper->body->value();

      $responses['cat_' . $cid]['metrics'][] = array(
        'metric_response_id' => $mrid,
        'category_id' => $cid,
        'description' => !empty($body) ? $body['value'] : '',
        'formula' => $metric_wrapper->field_metric_formula->value(),
        'value' => $metric_response_wrapper->field_metric_response_value->value(),
        'score' => $metric_response_wrapper->field_metric_response_score->value(),
      );
    }
  }

  // Assemble the final category scores.
  $scores = array();
  foreach ($cat_ids as $cid) {
    $score_item = array();

    if (!empty($responses['cat_' . $cid])) {
      $score_item = array_merge($responses['cat_' . $cid], $score_item);
    }

    $scores[] = $score_item;
  }

  return $scores;
}

/**
 * Calculate score for app type confirm page.
 */
function pgh_awards_score_calculate_apptype_form($form, &$form_state, $apptype_tag) {
  $form['description'] = array(
    '#markup' => 'This will take a few minutes to calculate scores for all applications of this application type, proceed ? <br />',
  );
  $atids = pgh_api_find_nodes(
    array(
      'type' => 'apptype',
    ),
    NULL, TRUE
  );
  $apptypes = node_load_multiple($atids);
  $options = array();
  foreach ($apptypes as &$apptype) {
    $options[$apptype->title] = $apptype->body['und'][0]['value'];
  }
  $form['apptype'] = array(
    '#type' => 'select',
    '#title' => 'Choose application type',
    '#options' => $options,
    '#default_value' => $apptype_tag,
  );

  $types = array(
    'automatic' => t('Automatic'),
    'kpi' => t('KPI'),
    'metric' => t('Metric'),
    'quality' => t('Quality'),
  );
  $form['scores'] = array(
    '#type' => 'checkboxes',
    '#title' => 'Choose score types',
    '#options' => $types,
    '#default_value' => array_keys($types),
  );

  $form['all'] = array(
    '#type' => 'checkbox',
    '#title' => 'Process all',
    '#description' => 'Check this if you are sure you want to calculate all the scores',
    '#default_value' => 0,
  );
  $form['debug'] = array(
    '#type' => 'textfield',
    '#title' => '[Debug] Set how many applications to process',
    '#default_value' => 1,
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Calculate',
  );

  return $form;
}

/**
 * Submit handler for calculation.
 */
function pgh_awards_score_calculate_apptype_form_submit($form, &$form_state) {
  $values = &$form_state['values'];
  $apptype_tag = $values['apptype'];

  // Find out all applications of this application type.
  $app_ids = pgh_api_find_nodes(
    array(
      'type' => 'application',
      'field_application_type' => $apptype_tag,
    ),
    NULL, TRUE
  );

  $operations = array();
  $debug = 0;
  if (empty($values['all'])) {
    if (isset($values['debug'])) {
      $debug = intval($values['debug']);
    }
  }
  $i = 0;
  foreach ($app_ids as $nid) {
    $operations[] = array('pgh_awards_score_calculate_apptype_op', array($nid));
    if ($debug) {
      $i += 1;
      if ($i >= $debug) {
        break;
      }
    }
  }
  $batch = array(
    'operations' => $operations,
    'finished' => 'pgh_awards_score_calculate_apptype_form_finished',
  );
  batch_set($batch);
}

/**
 * Finish handler for calculation.
 */
function pgh_awards_score_calculate_apptype_form_finished($success, $results, $operations) {
  if ($success) {
    drupal_set_message(t('@count applications calculated.', array('@count' => count($results))));
  }
  else {
    // An error occurred.
    // $operations contains the operations that remained unprocessed.
    $error_operation = reset($operations);
    drupal_set_message(t('An error occurred while processing id: @args',
      array('@args' => print_r($error_operation[0], TRUE))));
  }
}

/**
 * Op handler for calculation.
 */
function pgh_awards_score_calculate_apptype_op($app_id, &$context) {
  pgh_awards_score_calculate_application($app_id, TRUE);

  $context['results'][] = $app_id;
  $context['message'] = t('Calculating application "@nid"', array('@nid' => $app_id));
}

/**
 * Get a disabled list of displayable categories id based on application type.
 *
 * @param string $apptype_tag
 *   Application Type Tag String
 *
 * @author Fang Jin <fang@designhammer.com>
 */
function pgh_awards_score_quality_disabled_categories($apptype_tag) {
  $hiddens = array(
    'partner_for_change' => array(
      'PFC_demographic',
      'PFC_goals',
      'PFC_accuracy',
      'PFC_appendixA',
      'PFC_appendixB'
    ),
    'partner_recognition' => array(
      'PR_demographic',
      'PFC_goals',
      'PR_accuracy',
      'PR_appendixA',
      'PR_appendixB'
    ),
    'long_term_care' => array(
      'LTC_demographic',
      'PFC_goals',
      'LTC_accuracy',
      'LTC_appendixA',
      'LTC_appendixB'
    ),
    'champion_for_change_gpo' => array(
      // 'CFC_goals',
      'PFC_accuracy',
    ),
    'champion_for_change_nongpo' => array(
      // 'CFC_goals',
      'PFC_accuracy'
    ),
    'greening_the_or' => array(
      'PFC_goals',
      'PFC_accuracy'
    ),
    'dehp_free' => array(
      'PFC_accuracy'
    ),
    'system_for_change' => array(
      'PFC_goals',
      'PFC_accuracy'
    ),
    'mmmf' => array(
      'PFC_goals',
      'PFC_accuracy'
    ),
    'chc_partner_for_change' => array(
      'CHCPFC_demographic',
      'PFC_goals',
      'CHCPFC_accuracy',
      'CHCPFC_appendixA',
      'CHCPFC_appendixB'
    ),
    'chc_partner_recognition' => array(
      'CHCPR_demographic',
      'PFC_goals',
      'CHCPR_accuracy',
      'CHCPR_appendixA',
      'CHCPR_appendixB'
    )
  );

  if (!empty($hiddens[$apptype_tag])) {
    $cids = pgh_api_find_nodes(
      array(
        'type' => 'category',
        'title' => array($hiddens[$apptype_tag], 'IN')
      ),
      NULL, TRUE
    );

    return $cids;
  }

  return array();
}

/**
 * Based on question answer and property, calculate automatic and kpi scores.
 */
function pgh_awards_score_calculate_question_autokpi($value, $point, $score, $kpi, $type, $style, $options) {
  $r_point = 0; $r_score = 0; $r_kpi = '';
  switch ($type) {
    case 'text':
    case 'file':
      if (!empty($point[0])) {
        $r_point = $point[0];
      }
      if (!empty($value)) {
        if (!empty($score[0])) {
          $r_score = $score[0];
        }
        if (isset($kpi[0])) {
          $r_kpi = $kpi[0];
        }
      }
      break;

    case 'selection':
      switch ($style) {
        case 'checkboxes':
          if ($point) {
            $r_point = array_sum($point);
          }
          $i = 0;
          foreach ($options as $option) {
            if (!empty($value[$option])) {
              if (!empty($score[$i])) {
                $r_score += $score[$i];
              }
              if (isset($kpi[$i])) {
                $r_kpi += $kpi[$i];
              }
            }
            $i++;
          }
          // Serialize only applies to checkboxes.
          $value = serialize($value);
          break;

        case 'radios':
        case 'dropdown':
          if ($point) {
            $r_point = max($point);
          }
          if (!empty($score[$value])) {
            $r_score = $score[$value];
          }
          if (isset($kpi[$value])) {
            $r_kpi = $kpi[$value];
          }
          break;

        default:
          if (!empty($point[$value])) {
            $r_point = $point[$value];
          }
          if (!empty($score[$value])) {
            $r_score = $score[$value];
          }
          if (isset($kpi[$value])) {
            $r_kpi = $kpi[$value];
          }
          break;
      }
      break;

    default:
      // Should be error message.
      break;
  }

  $answer = array(
    'value' => $value,
    'point' => $r_point,
    'score' => $r_score,
    'kpi' => $r_kpi,
  );

  return $answer;
}

/**
 * Migrate score for app type confirm page.
 */
function pgh_awards_score_migrate_form($form, &$form_state) {
  $form['description'] = array(
    '#markup' => 'This will take a few minutes to migrate scores for all questions, proceed ? <br />',
  );

  $form['list'] = array(
    '#type' => 'textfield',
    '#title' => 'Application ID List',
    '#description' => 'Ex. 957166, 958928, 834766'
  );

  $form['range'] = array(
    '#type' => 'textfield',
    '#title' => 'Application ID Range',
    '#description' => 'Ex. 0,1000'
  );

  $form['all'] = array(
    '#type' => 'checkbox',
    '#title' => 'Process all',
    '#description' => 'Check this if you are sure you want to calculate all the scores',
    '#default_value' => 0,
  );
  $form['debug'] = array(
    '#type' => 'textfield',
    '#title' => '[Debug] Set how many applications to process',
    '#default_value' => 1,
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Calculate',
  );

  return $form;
}

/**
 * Submit handler for migration.
 */
function pgh_awards_score_migrate_form_submit($form, &$form_state) {
  $values = &$form_state['values'];

  $operations = array();
  // Debug option.
  $debug = 0;
  if (empty($values['all'])) {
    if (isset($values['debug'])) {
      $debug = intval($values['debug']);
    }
  }
  // OP option.
  $aids = array();
  if (!empty($values['list'])) {
    $list = explode(',', $values['list']);
    $aids = array_merge($aids, $list);
  }
  if (!empty($values['range'])) {
    $range = explode(',', $values['range']);
    if (count($range) > 1) {
      $aids = $range;
      array_unshift($aids, 'R');
    }
  }

  $i = 0;
  $pids = pgh_api_find_nodes(array('type' => 'question'), NULL, TRUE);
  foreach ($pids as $nid) {
    $operations[] = array('pgh_awards_score_migrate_op', array($nid, $aids));
    if ($debug) {
      $i += 1;
      if ($i >= $debug) {
        break;
      }
    }
  }
  $batch = array(
    'operations' => $operations,
    'finished' => 'pgh_awards_score_migrate_form_finished',
  );
  batch_set($batch);
}

/**
 * Finish handler for migration.
 */
function pgh_awards_score_migrate_form_finished($success, $results, $operations) {
  if ($success) {
    drupal_set_message(t('@count questions migrated.', array('@count' => count($results))));
  }
  else {
    // An error occurred.
    // $operations contains the operations that remained unprocessed.
    $error_operation = reset($operations);
    drupal_set_message(t('An error occurred while processing id: @args',
      array('@args' => print_r($error_operation[0], TRUE))));
  }
}

/**
 * Op handler for migration.
 */
function pgh_awards_score_migrate_op($qid, $aids, &$context) {
  // watchdog('pgh_score', $qid);
  $question = node_load($qid);
  $question_wrapper = entity_metadata_wrapper('node', $question);
  $point = $question_wrapper->field_question_point->value();
  $score = $question_wrapper->field_question_score->value();
  $kpi = $question_wrapper->field_question_kpi->value();
  $type = $question_wrapper->field_question_type->value();
  $style = $question_wrapper->field_question_style->value();
  $options = $question_wrapper->field_question_options->value();

  // $aids = array(957166, 958928, 834766);
  $query = array(
    'type' => 'response',
    'field_response_question' => array('target_id', $qid, '='),
  );
  if ($aids) {
    if ($aids[0] == 'R') {
      array_shift($aids);
      $query = array_merge($query, array(
        'field_response_application' => array('target_id', $aids, 'BETWEEN')
      ));
    }
    else {
      $query = array_merge($query, array(
        'field_response_application' => array('target_id', $aids, 'IN')
      ));
    }
  }

  $rids = pgh_api_find_nodes($query, NULL, TRUE);
  $responses = node_load_multiple($rids);
  $records = array();
  foreach ($responses as &$response) {
    $wrapper = entity_metadata_wrapper('node', $response);
    $value = $wrapper->body->value() ? $wrapper->body->value->raw() : '';
    $answer = pgh_awards_score_calculate_question_autokpi($value, $point, $score, $kpi, $type, $style, $options);

    // Save response back.
    $wrapper->body = array('value' => $answer['value']);
    $wrapper->field_response_point->set($answer['point']);
    $wrapper->field_response_score->set($answer['score']);
    $wrapper->field_response_kpi->set($answer['kpi']);
    $wrapper->save();
    $records[] = $response->nid;
  }
  if ($records) {
    watchdog('pgh_score', "[$qid] " . implode(",", $records));
  }

  $context['results'][] = $qid;
  $context['message'] = t('Migrating question @nid with @count responses', array('@nid' => $qid, '@count' => count($rids)));
}

/**
 * Migrate checkboxes for app type confirm page.
 */
function pgh_awards_score_checkboxes_form($form, &$form_state) {
  $form['description'] = array(
    '#markup' => 'This will take a few minutes to migrate scores for all checkboxes questions, proceed ? <br />',
  );

  $form['all'] = array(
    '#type' => 'checkbox',
    '#title' => 'Process all',
    '#description' => 'Check this if you are sure you want to calculate all the scores',
    '#default_value' => 0,
  );
  $form['debug'] = array(
    '#type' => 'textfield',
    '#title' => '[Debug] Set how many applications to process',
    '#default_value' => 1,
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Calculate',
  );

  return $form;
}

/**
 * Submit handler for migration.
 */
function pgh_awards_score_checkboxes_form_submit($form, &$form_state) {
  $values = &$form_state['values'];

  $operations = array();
  // Debug option.
  $debug = 0;
  if (empty($values['all'])) {
    if (isset($values['debug'])) {
      $debug = intval($values['debug']);
    }
  }

  $i = 0;
  $pids = pgh_api_find_nodes(
    array(
      'type' => 'question',
      'field_question_type' => 'selection',
      'field_question_style' => 'checkboxes',
    ),
    NULL, TRUE
  );
  foreach ($pids as $nid) {
    $operations[] = array('pgh_awards_score_checkboxes_op', array($nid));
    if ($debug) {
      $i += 1;
      if ($i >= $debug) {
        break;
      }
    }
  }
  $batch = array(
    'operations' => $operations,
    'finished' => 'pgh_awards_score_checkboxes_form_finished',
  );
  batch_set($batch);
}

/**
 * Finish handler for migration.
 */
function pgh_awards_score_checkboxes_form_finished($success, $results, $operations) {
  if ($success) {
    drupal_set_message(t('@count questions migrated.', array('@count' => count($results))));
  }
  else {
    // An error occurred.
    // $operations contains the operations that remained unprocessed.
    $error_operation = reset($operations);
    drupal_set_message(t('An error occurred while processing id: @args',
      array('@args' => print_r($error_operation[0], TRUE))));
  }
}

/**
 * Op handler for migration.
 */
function pgh_awards_score_checkboxes_op($qid, &$context) {
  $question = node_load($qid);
  $question_wrapper = entity_metadata_wrapper('node', $question);

  $query = array(
    'type' => 'response',
    'field_response_question' => array('target_id', $qid, '='),
    // 'field_response_application' => array('target_id', 155523, '=')
  );
  $rids = pgh_api_find_nodes($query, NULL, TRUE);
  $responses = node_load_multiple($rids);
  $records = array();
  foreach ($responses as &$response) {

    $wrapper = entity_metadata_wrapper('node', $response);
    $value = $wrapper->body->value() ? $wrapper->body->value->raw() : '';

    do {
      $value = unserialize($value);
    } while (is_string($value));

    if ($value) {
      $value = serialize($value);
    }
    else {
      $value = '';
    }

    $wrapper->body = array('value' => $value);
    if ($value == '') {
      $wrapper->save();
    }
    $records[] = $response->nid;
  }
  if ($records) {
    watchdog('pgh_score', "[$qid] " . implode(",", $records));
  }

  $context['results'][] = $qid;
  $context['message'] = t('Migrating question @nid with @count responses', array('@nid' => $qid, '@count' => count($rids)));
}
