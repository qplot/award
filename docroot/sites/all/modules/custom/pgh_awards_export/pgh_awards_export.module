<?php

/**
 * @file
 * Export module.
 *
 * @author Fang Jin <fang@designhammer.com>
 */

/**
 * Implements hook_menu().
 */
function pgh_awards_export_menu() {
  $items = array();

  // Calculate category score for one application.
  $items['admin/export'] = array(
    'title' => 'Export applications',
    'description' => 'Export application forms value and questions',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('pgh_awards_export_form'),
    'access arguments' => array('access administration pages'),
  );

  return $items;
}

/**
 * Export form.
 *
 * @author Fang Jin <fang@designhammer.com>
 */
function pgh_awards_export_form($form, &$form_state, $apptype_tag = NULL) {
  $form['description'] = array(
    '#markup' => 'This will take a few minutes to export all applications of this application type, proceed ? <br />',
  );
  $atids = pgh_api_find_nodes(
    array(
      'type' => 'apptype',
    ),
    NULL, TRUE
  );
  $apptypes = node_load_multiple($atids);
  $options = array();
  foreach ($apptypes as &$apptype) {
    $options[$apptype->title] = $apptype->body['und'][0]['value'];
  }
  $form['apptype'] = array(
    '#type' => 'select',
    '#title' => 'Choose application type',
    '#options' => $options,
    '#default_value' => $apptype_tag,
  );

  $form['all'] = array(
    '#type' => 'checkbox',
    '#title' => 'Process all',
    '#description' => 'Check this if you are sure you want to export all the applications',
    '#default_value' => 0,
  );
  $form['debug'] = array(
    '#type' => 'textfield',
    '#title' => '[Debug] Set how many applications to process',
    '#default_value' => 1,
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Export',
  );

  return $form;
}

/**
 * Submit handler for export.
 *
 * @author Fang Jin <fang@designhammer.com>
 */
function pgh_awards_export_form_submit($form, &$form_state) {
  $values = &$form_state['values'];
  $apptype_tag = $values['apptype'];

  // Create file and fill the header.

  // Find out all applications of this application type.
  $app_ids = pgh_api_find_nodes(
    array(
      'type' => 'application',
      'field_application_type' => $apptype_tag,
    ),
    NULL, TRUE
  );

  $operations = array();
  $debug = 0;
  if (empty($values['all'])) {
    if (isset($values['debug'])) {
      $debug = intval($values['debug']);
    }
  }
  $i = 0;
  foreach ($app_ids as $nid) {
    $operations[] = array('pgh_awards_export_op', array($nid));
    if ($debug) {
      $i += 1;
      if ($i >= $debug) {
        break;
      }
    }
  }
  $batch = array(
    'operations' => $operations,
    'finished' => 'pgh_awards_export_form_finished',
  );
  batch_set($batch);
}

/**
 * Finish handler for export.
 */
function pgh_awards_export_form_finished($success, $results, $operations) {
  if ($success) {
    drupal_set_message(t('@count applications exported.', array('@count' => count($results))));
  }
  else {
    // An error occurred.
    $error_operation = reset($operations);
    drupal_set_message(t('An error occurred while processing id: @args',
      array('@args' => print_r($error_operation[0], TRUE))));
  }
}

/**
 * Op handler for export.
 */
function pgh_awards_export_op($app_id, &$context) {
  // pgh_awards_score_calculate_application($app_id, TRUE);

  $context['results'][] = $app_id;
  $context['message'] = t('Calculating application "@nid"', array('@nid' => $app_id));
}

/**
 * Create export file.
 *
 * @author Fang Jin <fang@designhammer.com>
 */
function pgh_awards_export_createfile() {
  $dir = file_directory_temp();

  // Make sure the directory exists first.
  if (!file_prepare_directory($dir, FILE_CREATE_DIRECTORY | FILE_MODIFY_PERMISSIONS)) {
    $this->abort_export(t('Could not access temporary directory for result export (@dir). Check permissions.', array('@dir' => $dir)));
  }

  // Create a file with unique name prefixed with pgh.
  $path = drupal_tempnam($dir, 'pgh');

  // Save the file into the DB.
  $file = $this->file_save_file($path);

  return $file->fid;
}
