<?php

/**
 * hook menu
 */
function pgh_form_menu() {
  // $items['app/forms'] = array(
  //   'title' => 'Application Form Demo',
  //   'description' => 'Demo the application page section logic',
  //   'page callback' => 'drupal_get_form',
  //   'page arguments' => array('pgh_application_form'),
  //   'access callback' => TRUE,
  // );
  $items['application/%/category/%/edit'] = array(
    'title' => 'Fill Application',
    'description' => 'Fill an application',
    'page callback' => 'pgh_application_edit_form',
    'page arguments' => array(1, 3),
    'access callback' => TRUE,
  );

  return $items;

}

/**
 * Fill an application form
 */
function pgh_application_edit_form($app_id, $cat_id) {
  // load the app by app_id
  if ($app = node_load($app_id)) {
    $app_wrapper = entity_metadata_wrapper('node', $app);
    $apptype = $app_wrapper->field_application_type->value();

    $type_wrapper = entity_metadata_wrapper('node', $apptype);

    // set the page title
    $title = $type_wrapper->body->value->raw();
    drupal_set_title($app_wrapper->getIdentifier() . ' - ' . 'Application: ' . $title);

    // list all categories of the app
    $lists = array();
    foreach ($type_wrapper->field_apptype_categories->getIterator() as $cat_wrapper) {
      $cat_label = $cat_wrapper->getIdentifier() . ' - ' . $cat_wrapper->body->value->raw();
      $lists[] = l($cat_label, 'application/' . $app_id . '/category/' . $cat_wrapper-> getIdentifier() . '/edit');
    };

    $out['categories'] = array(
      '#theme' => 'item_list',
      '#items' => $lists,
      '#title' => t(''),
      // '#attributes' => array('class' => array('my-links')),
    );

    // render category form
    $out['forms'] = drupal_get_form('pgh_application_form', $app_id, $cat_id);

    return drupal_render($out);

  }

  return '123';
}

/**
 * Application form
 */
function pgh_application_form($form, &$form_state, $app_id = NULL, $cat_id = NULL) {  
  $form = array();

  if (empty($app_id) || empty($cat_id)) return $form;
  // $form['name'] = array(
  //   '#type' => 'item',
  //   '#title' => t('Notes'),
  //   '#markup' => 'This is for demonstration purpose :) It lists all questions for PFC <b>application type</b> and Leadership <b>category</b>. '
  // );

  // load cateogry by name, can be id as well
  $cat = node_load($cat_id);
  $questions = array();

  if (!empty($cat->field_category_sections['und'])) {
    // for debugging purpose add a counter
    $debug = 0; $total = 1;
    foreach ($cat->field_category_sections['und'] as $sec_id) {
      if ($sec = node_load($sec_id['target_id'])) {
        $sec_wrapper = entity_metadata_wrapper('node', $sec);

        $caption = $sec_wrapper->field_section_label->value();

        // add a fieldset to hold section info
        $fieldset = 'fieldset_' . $sec_wrapper->title->value();
        $form[$fieldset] = array(
          '#type' => 'fieldset',
          '#title' => t($caption),
          '#collapsible' => TRUE,
          '#collapsed' => FALSE,
        );

        // add all question inside this section
        // $form[$fieldset] = array();
        foreach ($sec_wrapper->field_section_questions->getIterator() as $q_wrapper) {

          $major = 'question_' . $q_wrapper->label();
          $question = pgh_gen_form_question($q_wrapper->value(), $app_id);
          foreach ($question as $key => $value) {
            $questions[] = $key;
            $form[$fieldset][$major] = $question;
          }
          $debug = $debug + 1;
          if ($debug == $total) break;
          // support one level of layout here
          // $layout = array('pghq_pfc_l1i1', 'pghq_pfc_l1i2');
          // foreach ($layout as $row) {
          //   $children = node_load_multiple(array(), array('title' => $row));
          //   if (!empty($children)) {
          //     $child = reset($children);

          //     $questions[] = $child->nid;
          //     $minor = 'question_' . $child->title;
          //     $form[$fieldset][$minor] = pgh_gen_form_question($child, $app_id);
          //   }
          // }
        }
        if ($debug == $total) break;
      }
    }
  }

  $form['submit'] = array(
    '#type' => 'submit', 
    '#value' => 'Submit',
  );

  $form['application'] = array(
    '#type' => 'hidden',
    '#value' => $app_id
  );
  $form['questions'] = array(
    '#type' => 'hidden',
    '#value' => $questions
  );

  return $form;
}

/**
 * Application form submit 
 */
function pgh_application_form_submit($form, &$form_state) {
  // dsm($form_state['values']);

  // since preparation have all response ready, we just need to save one by one
  $app_id = $form_state['values']['application'];

  foreach ($form_state['values']['questions'] as $qid) {

    $question = node_load($qid);
    $wrapper = entity_metadata_wrapper('node', $question);
    $type = $wrapper->field_question_type->value();

    // save response if the question expects a response
    if (!in_array($type, array('html', 'container'))) {
      // assign question value 
      $value = $form_state['values'][$qid];

      // assign point
      $points = $wrapper->field_question_points->value();

      $point = 0;
      switch ($type) {
        case 'text':
          if (!empty($value) && !empty($points))
            $point = $points;
          break;
        case 'selection':
          if (is_numeric($value) && is_array($points) && !empty($points[$value]))
            $point = $points[$value];
          break;
        
        default:
          # code...
          break;
      }

      $answer = array(
        'value' => $value,
        'point' => $point,
      );
      pgh_set_response($app_id, $qid, $answer);
    }
  }
}

/**
 * Return form element based on question settings
 */
function pgh_gen_form_question($question, $app_id = NULL) {
  $wrapper = entity_metadata_wrapper('node', $question);
  $type = $wrapper->field_question_type->value();
  $prompt = $wrapper->field_question_prompt->value();
  $style = $wrapper->field_question_style->value();

  // prepare response for question expecting a response
  $answer = array('value' => '', 'point' => 0);
  $response_edit = '';
  $point_edit = '';
  if (!in_array($type, array('html', 'container'))) {
    $rid = pgh_get_response($app_id, $wrapper->getIdentifier(), $answer);
    if (!$rid) pgh_set_response($app_id, $wrapper->getIdentifier());
    $response_edit = '<small>' . l('[R]', 'node/' . $rid . '/edit') . '</small>';
    $point_edit = ' <small>[P' . intval($answer['point']) . ']</small> ';
  }

  $form = array();
  $question_edit = '<small>' . l('[Q]', 'node/' . $wrapper->getIdentifier() . '/edit') . '</small>';
  $form['#title'] = $prompt . ' ' .
                    $question_edit . ' ' . 
                    $response_edit . ' ' . 
                    $point_edit;

  $form['#default_value'] = $answer['value'];

  // based on different question type
  switch ($type) {
    case 'html':
      $form['#markup'] = $form['#title'];
      unset($form['#title']);
      break;
    case 'container':
      break;
    case 'text':
      $form['#type'] = 'textfield';
      break;
    case 'selection':
      $options = $wrapper->field_question_options->value();

      switch ($style) {
        case 'dropdown':
          $form['#type'] = 'select';
          $form['#options'] = $options;
          break;
        case 'default':
        case 'radios':
          $form['#type'] = 'radios';
          $form['#options'] = $options;
          break;
        case 'checkboxes':
          $form['#type'] = 'checkboxes';
          $form['#options'] = drupal_map_assoc($options);
          if (empty($answer['value']))
            unset($form['#default_value']);
          break;
        default:
          $form['#markup'] = '<b><em>Not Implemented Style - '. $style . '</em></b>';
          break;
      }

      break;
    
    default:
      $form['#markup'] = '<b><em>Not Implemented Type - '. $type . '</em></b>';
      break;
  }

  return array($wrapper->getIdentifier() => $form);

  // return array(
  //   '#description' => '',
  //   '#access'
  // );

}

/**
 * Find response by application and question id
 */
function pgh_find_response_id($app_id, $qid) {
  $query = new EntityFieldQuery();
  $result = $query->entityCondition('entity_type', 'node')
                  ->propertyCondition('type', 'response')
                  ->fieldCondition('field_response_application', 'target_id', $app_id)
                  ->fieldCondition('field_response_question', 'target_id', $qid)
                  ->execute();
  if (!empty($result['node'])) {
    $keys = array_keys($result['node']);
    return $keys[0];
  }
  else
    return 0;
}

/**
 * Load question answer,
 * return FALSE if no response is found
 */
function pgh_get_response($app_id, $qid, &$response) {
  $rid = pgh_find_response_id($app_id, $qid);
  if ($rid) {
    $response = node_load($rid); 
    $wrapper = entity_metadata_wrapper('node', $response);

    $response = array(
      'value' => $wrapper->body->value->raw(),
      'point' => $wrapper->field_response_point->value(),
    );
    return $wrapper->getIdentifier();
  }

  return 0;
}

/**
 * Set question response
 */
function pgh_set_response($app_id, $qid, $answer = array()) {
  // set default answer
  $default = array(
    'value' => '',
    'point' => 0,
  );
  $answer = array_merge($default, $answer);

  // find response
  $rid = pgh_find_response_id($app_id, $qid);
  if ($rid) {
    $response = node_load($rid);
    $wrapper = entity_metadata_wrapper('node', $response);
  } else {
    // create a new response
    $response = entity_create('node', array('type' => 'response'));
    $wrapper = entity_metadata_wrapper('node', $response);
    $wrapper->field_response_application->set($app_id);
    $wrapper->field_response_question->set($qid);
  }
  $wrapper->title = 'app_' . $app_id . '_q_' . $qid; 
  if ($answer) {
    $wrapper->body = array(
      'value' => $answer['value']
    );
    $wrapper->field_response_point->set($answer['point']);
  }
  $wrapper->save();
  node_save($response);
  return $response->nid;
}

/**
 * Parser layout string into array
 * Given a string with ; and , delimiter for rows and columns
 */
function pgh_parser_layout($str) {  

}
